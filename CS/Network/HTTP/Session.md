# HTTP Session

- 세션은 클라이언트 별로 각각의 상태 정보를 서버에 저장할 수 있는 기술이다.
- 데이터 파일을 브라우저에서 관리하는 '쿠키'와 달리, '세션'은 서버 측에서 이를 관리한다. 로그인 상태 유지, 쇼핑몰 장바구니 기능 등에 사용될 수 있다.

<img src="https://user-images.githubusercontent.com/67703882/201508448-22e8d059-69b0-4fb3-94f8-3a4853c650ac.png" alt="image" style="zoom:67%;" />

## 세션 트래킹 모드

- 서버가 각 클라이언트들에 부여한 ID를 어떤 방식으로 추적할 지 정의한 것이 **'세션 트래킹 모드'**이다.
- 주로 사용되고 권장되는 방식은 **'쿠키 기반 모드'**로, 브라우저 쿠키에 ID를 담아 트래킹하는 방식이다.  브라우저 호환성이 높고 구현이 간단하다.
- 이밖에도 URL Rewriting 모드, SSL 모드 등이 있다.

## 쿠키 기반 세션 동작 과정

1. 클라이언트는 서버에 접속 요청을 한다. 
2. 서버는 클라이언트 별로 고유한 Session ID(SID)를 생성한 후, 응답 헤더에 `Set-Cookie: session_id=<SID>` 를 추가하여 응답한다.
3. 브라우저는 이 쿠키를 일반 쿠키처럼 저장해두었다가, 동일한 도메인 요청 시 해당 쿠키를 함께 전송한다.  
4. 서버는 전달 받은 쿠키에 담겨 있는 **Session ID**로 세션 저장소에 있는 클라이언트 정보를 가져온다. 
5. 이러한 클라이언트 정보를 가지고 서버 요청을 처리하여 클라이언트에 응답한다. 

## 세션 vs 쿠키

- 쿠키와 다르게 세션은 서버에서 관리하기 때문에 보안성 측면에서는 유리하지만, 사용자가 많아질수록 서버의 저장 공간을 많이 차지하게 된다. 
  - `session-timeout` 등 세션에 만료일시를 지정하고, 그 일시까지 재요청이 없다면 세션 정보를 DB에서 삭제하는 방법을 사용할 수 있다.

- 쿠키는 쿠키 자체에 데이터가 있기 때문에 서버 요청시 헤더를 바로 참조하면 되지만, 세션은 Session ID을 통해 서버에서 다시 데이터를 참조해야 하므로 비교적 속도가 느리다. 

## 세션 동기화 

서버 가용성을 위해 여러 대의 서버가 동시에 운영되고 있다면, '세션을 어떻게 동기화'시킬 지, 즉 서버들이 어떻게 세션을 공유하도록 할지 방안을 마련해야 한다.

- Sticky Session: 클라이언트별로 담당 처리 서버를 지정하는 방식으로, 클라이언트에 쿠키를 전달할 때 서버 ID나 IP 주소를 포함하는 등 방법을 사용할 수 있다. 구현은 간단하지만, 특정 서버에 부하가 집중될 수 있고 세션 정보가 아예 손실될 수도 있다는 단점이 있다.
- Session Clustering: 세션 정보를 TCP Socket으로 서버끼리 공유하는 방식이다. 이는 서버가 공유해야 할 서버를 모두 알고 있어야 하므로 수많은 서버를 사용하는 대규모 시스템에서는 적합하지 않다.
- Session Server: 외부 저장소에서 세션을 관리하는 방식으로, 최초 요청을 받은 서버가 세션 정보를 생성하여 외부 저장소, 혹은 이를 관리하는 서비스(ex. `Redis`)에 전달한다. 응답 속도가 비교적 느리고 세션 서버가 죽으면 모든 세션 정보가 손실된다는 단점이 있지만, 서버를 스케일 아웃하기 편하고 마이크서비스에 아주 적합하다. 


## 참고 자료

- https://thecodinglog.github.io/web/2020/08/11/what-is-session.html