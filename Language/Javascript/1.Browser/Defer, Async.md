# defer, async 스크립트

## 브라우저의 스크립트 처리

- 기본적으로 브라우저는 HTML을 읽다가 `<script>` 를 만나면 DOM 생성을 멈추고 스크립트를 다운받고 실행한다. 스크립트 실행을 완료한 이후에 남은 페이지를 처리한다.

- 따라서 스크립트는 스크립트 아래에 있는 DOM 요소에 접근할 수 없다. 그래서 보통 우리는 `<script>` 태그를 `<body>` 맨 하단에 두어 이러한 문제를 방지한다.

  ```html
  <body>
    <p>..</p>
    <script src="/script.js"></script>
  </body>
  ```

- 하지만 위와 같은 해결책 역시 완벽한 것은 아니다. 만약 DOM 요소는 모두 완성되었기에 사용자가 버튼을 클릭하는 등 상호작용을 할 수 있게 되었으나, 그 시점에 스크립트가 아직 다 로드되지 않았다면 기능이 제대로 동작하지 않을 것이다.

이러한 문제는 브라우저가 스크립트 파일들을 '병렬'로 불러오도록 하는 `defer` 와 `async` 속성을 사용하여 해결할 수 있다.

## defer

- `defer` 속성이 있는 스크립트는 '백그라운드'에서 다운로드한다. 이러한 스크립트를 '지연 스크립트'라 한다.
- 즉, 지연 스크립트의 다운은 HTML 파싱, 즉 페이지 생성을 절대 방해하지 않는다.
- 이렇게 다운된 지연 스크립트는 페이지 구성이 끝날 때까지 기다렸다가, DOM이 준비된 이후에 실행된다.
- 지연 스크립트가 실행된 이후에 `DomContentLoaded` 이벤트가 발생한다.
  - `DomContentLoaded` 는 DOM 구성이 완료되었을 경우 발생하는 이벤트이다.

### 주의할 점

- `defer` 속성은 외부 스크립트에만 유효하다.
- 여러 지연 스크립트를 불러오는 경우, 이들을 '병렬적으로' 다운로드하되 실행 순서는 HTML에 추가된 순서로 실행된다.
- 따라서 DOM이나 다른 스크립트에 의존성이 있고, 스크립트 실행 순서가 중요한 경우 이를 사용할 수 있다.

## async

- `async` 속성이 있는 스크립트 '비동기 스크립트 혹은 async 스크립트'라고 한다.
- 비동기 스크립트도 지연 스크립트와 마찬가지로 백그라운드에서 다운로드한다. 그리나 만약 **비동기 스크립트 다운이 완료하면 그 즉시 페이지 생성을 멈추고 스크립트 실행을 시작**한다.
- 이는 비동기 스크립트가 실행되는 시점에서 DOM 구성이 완료되었을 것이라 보장할 수 없다는 걸 의미한다. 만약 스크립트가 아주 빨리 로드되었다면 해당 스크립트가 접근하고자 하는 DOM 요소가 아직 생성되지 않았을 수도 있다.
- 따라서 비동기 스크립트는 DOM 요소가 완료된 `DomContentLoaded` 이벤트와는 무관하게 실행된다.

### 주의할 점

- 만약 여러 개의 비동기 스크립트를 불러온다면, 마찬가지로 병렬적으로 다운로드하되 실행 순서는 다운로드가 끝난 순서대로 진행된다. 즉 <u>스크립트 간의 실행 순서를 정확히 예측할 수 없다</u>.
- 따라서 비동기 스크립트는 DOM이나 다른 스크립트에 의존성이 없는 경우 사용된다.

### 동적 스크립트

```js
const script = document.createElement('script');
script.src = '/script.js';
document.body.append(script);
```

- 스크립트를 동적으로 추가한 경우, 기본적으로 'async 스크립트'처럼 행동한다.
- 따라서 해당 스크립트의 다운이 다른 작업을 절대 방해하지 않으며, 만약 여러 개의 스크립트를 동적으로 추가한 경우 먼저 다운된 순서대로 스크립트가 실행된다.
- 만약 추가한 순서대로 스크립트를 실행하고 싶다면 `script.async=false` 를 추가하면 된다.
