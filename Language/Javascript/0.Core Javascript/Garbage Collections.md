# 가비지 컬렉션

자바스크립트 엔진이 어떻게 메모리 관리를 하는지 알아보자.

## Reachability

자바스크립트는 '도달 가능성(reachability)' 라는 개념을 이용해 메모리 관리를 한다. <u>도달 가능한 값은 어떻게 든 접근하거나 사용할 수 있는 값</u>으로, 메모리에서 삭제되지 않는다. 다음과 같은 값들은 도달 가능하다.

- 태생부터 도달 가능하여, 명백한 이유 없이 삭제되지 않는 값들을 **루트**라고 부른다.
  - 현재 함수의 지역 변수 및 매개변수
  - 중첩 함수의 체인에 있는 함수에서 사용되는 변수와 매개변수
  - 전역 변수
- 루트가 참조하는 값이나 체이닝으로 루트에서 참조할 수 있는 값
  - ex. 전역 변수에 저장된 객체의 프로퍼티가 또 다른 객체를 참조하고 있다면, 그 객체는 도달 가능한 값이 된다.

## Garbage Collector

자바스크립트 엔진 내 **가비지 컬렉터**(garbage collector)는 모든 객체를 모니터링하고, 도달할 수 없는 객체를 삭제하는 역할을 한다.

```js
let user = { name: 'sona' };
user = null;
```

위 코드에서 `user` 변수는 `{name:'sona'}` 라는 객체를 참조하다가, null 값으로 덮어 쓰이면서 참조가 사라진다. 더이상 `{name:'sona'}` 는 참조 및 접근할 방법이 없는 객체가 되었으므로, 가비지 컬렉터는 객체에 저장된 데이터와 객체를 메모리에서 삭제한다.

```js
let user = { name: 'sona' };
let admin = user;
user = null;
```

위와 같은 경우 똑같이 `user` 변수 값이 null로 덮여 쓰였으나, 여전히 `admin` 을 통해 객체에 접근할 수 있기 때문에, 객체는 제거되지 않는다.

## 내부 알고리즘

가비지 컬렉터가 동작하는 알고리즘은 기본적으로 'Mark-and-Sweep' 방식이다.

1. 루트 정보를 수집하고 이를 mark(기억)한다.
2. 루트가 참조하는 모든 객체들을 방문하고 이들을 mark 한다.
3. mark된 모든 객체와 그 객체들이 참조하는 객체까지 모두 mark 한다.
4. 도달 가능한 모든 객체를 방문할 때까지 이 과정을 반복한다.
5. mark 되지 않은 모든 객체는 메모리에서 삭제한다.

### 최적화

엔진 성능을 높이기 위해 가비지 컬렉터의 알고리즘을 최적화하는 기법들이 많이 등장했다. 대표적인 기법들은 다음과 같다.

- 일정 시간 이상 동안 살아남은 객체는 제거되지 않을 확률이 높다고 판단하여, 가비지 컬렉터가 덜 감시하도록 한다.
- 모든 객체를 탐색하는 데 걸리는 시간을 줄이기 위해, 가비지 컬렉션을 여러 부분으로 분리하여 각 부분을 별도로 추적한다.
- CPU가 idle 상태일 때만 가비지 컬렉션을 실행하도록 한다.

[참고: V8 엔진 내부의 메모리 관리 시각화하기](https://ui.toast.com/weekly-pick/ko_20200228)
