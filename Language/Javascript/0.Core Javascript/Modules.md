# 모듈

애플리케이션의 크기가 커서 여러 개로 분리할 때, 분리된 파일을 '모듈(module)' 이라고 한다. 보통 클래스 하나 혹은 특정한 목적을 가진 여러 개의 함수로 구성된다.

> 과거에는 AMD, CommonJS, UMD 등 모듈 시스템이 존재했었다.

## module

- 스크립트 하나는 모듈 하나다.
- `export`
- `import`
- 모듈은 로컬 파일에서 동작하지 않고, HTTP/HTTPS 프로토콜을 통해서만 동작한다?

## 모듈 특징

- 항상 엄격 모드로 실행된다.
- 모듈 레벨 스코프를 갖는다. 따라서 모듈 내부에서 정의한 변수나 함수는 해당 모듈이 내보내지 않는 이상 다른 스크립트에서 접근할 수 없다.
- 동일한 모듈이 여러 곳에서 사용되더라도 최초 호출 시 '한 번만' 실행된다.
- `import.meta` 객체는 현재 모듈에 대한 정보를 제공해준다.
  - 예를 들어 브라우저 환경일 경우 `import.meta.url` 은 스크립트 URL 정보를 반환한다.
- 모듈 최상위 레벨의 `this` 는 전역 객체가 아니라 `undefined` 이다.

## type="module"

```html
<script type="module">
  //...
</script>
```

브라우저 환경에서 일반 스크립트와 `type="module"` 이 붙은 모듈 스크립트는 무엇이 다를까?

### 지연 실행

- 모듈 스크립트는 항상 '지연 실행'된다. 즉, `defer` 속성이 붙은 것처럼 실행된다.
- 따라서 모듈 스크립트를 불러올 때 HTML 처리가 멈추지 않고, 여러 모듈 스크립트을 병렬적으로 불러온다. 이후 다운 완료 시점과 상관없이 <u>DOM 구성이 완료되면 스크립트 실행이 시작</u>된다.

### 인라인 스크립트의 비동기 처리

- `async` 속성은 외부 스크립트를 불러올 때만 유효하지만, 모듈 스크립트인 경우 인라인 스크립트에도 적용할 수 있다.
- 만약 `<script async type="module">` 으로 선언된 스크립트라면 HTML 페이지 구성과 다른 스크립트 실행과 관계 없이 다운로드되어 실행된다.

### 외부 스크립트

- 만약 동일한 외부 스크립트를 여러 번 불러와도 한 번만 실행된다.
- CORS 정책에 의해 만약 다른 오리진의 모듈 스크립트를 불러오려면, 그 스크립트를 제공하는 서버가 헤더에 `Access-Control-Allow-Origin: * (or 허용할 도메인)` 를 제공해야 한다.

## 빌드 툴

번들러는 모듈 스크립트를 비롯한 다양한 리소스들을 모아서, 최적의 소수 파일로 결합해준다.

- 모듈 분석을 통해 모듈 간의 의존 관계 파악하고, 모듈 전체를 하나(혹은 여러 개)의 큰 파일로 모으기. 이 과정에서 `import` , `export`문은 번들러 함수로 대체
- 이 과정에서 다양한 기능을 함께 수행
  - 도달 가능하지 않은 코드나 `console` 등 개발 관련 코드는 삭제하기
  - 모듈을 chunk로 분리하여, 동적으로 필요한 모듈만 로드하기(code-splitting)
  - export된 모듈 중 쓰이는 곳이 없는 모듈은 삭제하기(tree-shaking)
  - babel 사용해서 최근 자바스크립트 문법을 구버전으로 변환하기
  - 공백 제거, 변수 이름 줄이기 등으로 파일 크기 줄이기
- webpack, rollup, esbuild, vite 등
