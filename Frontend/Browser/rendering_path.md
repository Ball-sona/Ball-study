# 브라우저 렌더링

브라우저 렌더링 엔진이 어떻게 동작하는지 알아보자. 

> 사파리는 Webkit, 파이어폭스는 Gecko, 크롬과 엣지는 Blink 엔진을 사용하고 있다.

## 1. DOM 트리 생성 

- DOM(Document Object Model) 생성
  - HTML의 원시 바이트를 읽어서 지정된 인코딩(ex. UTF-8)에 따라 이를 개별 문자로 '변환'한다.
  - 각 문자열을 W3C 표준에 지정된 고유한 '토큰'으로 변환한다. (파싱)
  - 토큰을 해당 속성 및 규칙을 정의하는 '객체'로 변환한다. (렉싱)
  - 여러 태그 간 관계를 해석해서 트리 구조로 연결한다. 
- CSSOM(CSS Object Model) 생성
  - style 태그 혹은 외부 css 파일에 정의한 스타일을 파싱하여 트리를 생성한다.

## 2. 렌더링 트리 생성

- 앞서 생성한 DOM 트리와 CSSOM 트리를 결합하여 '렌더링 트리(Rendering Tree)'를 만든다. 
  - DOM 트리의 루트에서 시작하여 각 노드를 순회한다.
  - 이때 head 태그 등 비시각적 요소나, `display:none` 등 css에 의해 숨겨질 노드는 렌더링 트리 에서 생략된다.
  - 렌더링 트리에 표시 될 각 노드에 대해 적절한 CSSOM 규칙을 찾아 적용한다.

- 즉, 렌더링 트리는 **요소들이 표시되어야 할 순서와 적용될 스타일이 모두 반영**된 트리를 의미한다.

## 3. 레이아웃 단계

- 렌더링 트리를 순회하며 실제 화면 영역(viewport) 내에서 **노드의 정확한 위치와 크기를 계산**하는 과정을 layout(or reflow) 라고 한다.
  - 뷰포트에 상대적인 속성값(vh,vw)은 화면의 절대적인 픽셀로 변환된다.

- '전역적 레이아웃'이란, 화면 전체의 레이아웃을 계산하는 것을 의미한다.
  - 만약 새로운 폰트를 적용하거나 뷰포트 사이즈가 변경되는 경우, 혹은 자바스크립트에서 `offsetHeight` 를 사용하는 경우 전체 레이아웃을 다시 계산하게 된다. 

- 반면 '증분적(Incremental) 레이아웃'은 특정 요소의 레이아웃이 변경되었을 경우 이에 영향을 받은 특정 부분만 다시 계산하는 방식이다. 
  - '더티 비트 시스템'을 활용하는데, 이는 레이아웃이 업데이트되어야 하는 요소를 만나면 즉시 계산을 수행하지 않고 스케줄러를 통해 비동기로 일괄 업데이트하는 것을 의미한다. 
  - 이를 통해 리소스 낭비를 줄이고 레이아웃 과정을 최적화할 수 있다.


## 4. 페인팅 단계

- 레이아웃 단계가 완료되면, 노드들의 위치나 스타일 계산이 모두 완료된 **렌더링 트리를 실제 화면에 그리는 과정**을 페인팅(레스터화) 과정이라 한다.
- 그림자 등 복잡한 스타일 속성이 추가될수록 이 과정에 걸리는 시간도 늘어난다.

## 5. Reflow, Repaint

### Reflow

- 사용자 인터렉션 등에 의해 요소가 추가되거나 기존 요소의 스타일이 변경되면, 이에 영향 받는 모든 노드에 대해서 <u>렌더링 트리 생성 및 레이아웃 과정을 다시 수행</u>하게 된다. 이 과정을 'Reflow' 라고 한다.
- 초기 렌더링 이후에는, 윈도우가 리사이징되거나 노드의 위치나 크기가 변경되거나, 폰트 혹은 이미지 크기 등이 변경되었을 경우 리플로우가 발생한다.

### Repaint

- Reflow에 의해 렌더링 트리가 업데이트되어 이를 화면에 다시 그려야하거나, 혹은 Reflow는 일어나지 않았지만 배경색 등 스타일 속성이 업데이트되었을 경우 이를 실제 화면에 반영하는 과정을 'Repaint' 라고 한다.

- background-color, visibility 등 속성 변경시 리페인트가 발생한다.

## 참고 자료

- https://d2.naver.com/helloworld/59361
- https://boxfoxs.tistory.com/408
- https://yozm.wishket.com/magazine/detail/1338/