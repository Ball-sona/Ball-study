# React Fiber

리액트는 '리액트 파이버(React Fiber)' 를 통해 가상 DOM 및 렌더링 과정 최적화를 가능하게 해준다.

https://d2.naver.com/helloworld/2690975

https://blog.mathpresso.com/react-deep-dive-fiber-88860f6edbd0

## Fiber

- 리액트 파이버는 결국 '자바스크립트 객체'이다.

## Reconciliation

- 가상 DOM과 실제 DOM을 비교해 변경 사항을 수집하며, 만약 이 둘 사이에 차이가 있으면 **변경에 관련된 정보를 가지고 있는 파이버를 기준**으로 화면에 렌더링을 요청하는 과정이다.

- n개의 엘리먼트가 있는 트리를 다른 트리로 변환하는 알고리즘의 복잡도는 최소 O(n^3)이지만, 리액트는 아래 두 조건을 전제로 복잡도가 O(n)인 알고리즘을 재조정에 사용한다.

  1. 서로 다른 타입의 두 엘리먼트는 서로 다른 트리를 만들어낸다. -> 이전과 다른 타입의 리액트 엘리먼트로 교체되었다면 하위 트리는 더이상 비교하지 않고 전체를 교체한다.
  2. 개발자가 key prop을 통해. 여러 렌더링 사이에서 어떤 자식 엘리먼트가 변경되지 않아야 할지 표시해줄 것이다. -> key가 동일한 리액트 엘리먼트는 이전과 동일한 엘리먼트로 취급한다.

- DOM 업데이트, 렌더링 로직을 작업 단위로 구분하고. 이를 비동기로 실행하여 최대 실행 시간이 16ms가 넘지 않도록 제어한다.
- 작업을 청크로 분리해서 실행 시간을 관리하는 것 뿐만 아니라. 작업 유형에 따라 우선순위 부여하고. 우선순위에 따라 실행하는 기능

### 어떻게 구현되어있나

- 하나의 작업 단위로 구성
  - 렌더 단계 -> 비동기 작업 수행
  - 커밋 단계 -> 돔에 실제 변경 사항 반영. 동기적으로 동작
- 컴포넌트가 최초로 마운트되는 시점에 생성되어. 이후 가급적 재사용된다.

### 실행

- 파이버는 state가 변경되거나 생명주기 메서드 실행되거나 DOM 변경 필요한 시점에 실행
- 그리고 이러한 실행 작업은 바로 처리하기도 하고. 스케줄링해서 처리하기도 하고.

## Fiber 객체 속성

```
function FiberNode(tag, pendingProps, key, mode) {
	this.tag = tag;
	this.key = key;

}
```

- tag: Fiber는 하나의 요소와 1:1 관계이다. 여기서 요소는 리액트의 컴포넌트일수도. HTML DOM 노드일 수도. 혹은 다른 것일수도. 이 요소 정보를 나타내는게 tag
- stateNode: 파이버 자체에 대한 참조 정보
- child, sibling, return: 파이버 간의 관계를 나타내는 속성. 파이버도 트리 형식을 갖는데. 하나의 자식ㅁㄴ 갖는다.
- pendingProps: 아직 작업을 미처 처리하지 못한 props
- memoizedProps: 렌더링 완료된 이후 pendingProps가 memoizedProps로 저장되어 관리됨
- updateQueue
- memoizdState: 함수형 컴포넌트 훅 목록이 저장
- alternate

## 파이버 트리

- 2개의 트리
  - 현재
  - workingTree
- 왜 2개?

## 결론

- 파이버는 컴포넌트에 대한 정보를 1:1로 가지고 있는 자바스크립트 객체이다.
- 이 파이버를 컴포넌트가 처음 마운트될 때 처음 생성한 이후. 가급적 계속 재사용한다.
- 파이버는 트리로 구성되어 있다. 이 파이버 트리는 현재 UI를 나타내는 트리와 작업 중인 상태를 나타내는 workInProgress 트리 총 2개로 구성된다.
- setState 실행 등으로 인해. workInProgress 트리를 업데이트하는 작업은 비동기적으로 실행된다. 즉 우선순위 등 고려해서 업데이트.
- 반면 업데이트한 트리를 화면에 반영하는 건 동기적으로 일어난다.
- 업데이트 작업은 메모리 상에서 먼저 수행한후 최종 결과물만 실제 브라우저 돔에 적용하는 방식 -> 더블 버퍼링?

## 핵심

가상 돔과 리액트의 핵심은. UI를 값으로 관리한다는 것. 변수에 UI 관련된 값을 보관하고. 자바스크립트 코드 흐름에 따라 이를 관리하고. 표현하는 게 리액트의 핵심이다.
